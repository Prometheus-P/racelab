# v1.4 Refine Cycle: Project to Production-Ready Specification

## 1. 개요 (Project Summary)

### 1.1 프로젝트 정보
| 항목       | 내용                                             |
|------------|--------------------------------------------------|
| **프로젝트명** | racelab                                          |
| **버전**     | v1.4 Refine (targeting minimum production-ready) |
| **도메인**   | 한국 공영경주(경마/경륜/경정) 정보 포털          |
| **기술 스택**| Next.js 14 (App Router) + React 18 + TypeScript + Tailwind + Vercel |

### 1.2 이번 사이클의 핵심 목표
racelab을 "예쁘게 포장된 데모" 수준에서 "실제 서비스로 돌릴 수 있는 최소 프로덕션" 수준으로 끌어올린다. 특히 다음 5가지를 개선한다:
1. 문서/버전 싱크 및 단일 진실(Single Source of Truth) 정리
2. 레이스 도메인 모델 보강 (date, meetCode, 안정적인 ID 전략)
3. 외부 API 레이어 정리 및 스펙 단일화
4. 경주 상세 페이지 UX 리디자인 (정보 구조 중심)
5. 관측/SEO/측정 초기 세팅 (GA4 + Search Console + 에러 로깅)

## 2. 문서 & 거버넌스 개선 (Document & Governance Requirements)

### 2.1 CONTEXT.md 강화
- **목표**: CONTEXT.md를 "레포 전체의 SSOT"로 만든다.
- **요구사항**:
    - 현재 릴리즈 버전(v1.3.x)을 반영하여 버전 정보/변경 이력/알려진 이슈를 업데이트한다.
    - 이미 해결된 이슈(/public 디렉토리 등 과거 임시 문제)는 제거하거나 "해결됨"으로 명시한다.

### 2.2 API 스펙 단일 진실 정의
- **목표**: API 스펙의 단일 진실을 정의한다.
- **요구사항**:
    - `docs/technical/API_README_v2.md`를 외부 API 최종 스펙으로 지정한다.
    - `docs/technical/TECHNICAL_DESIGN.md` 안의 API 상세 테이블은 요약(엔드포인트 그룹 설명 + 링크)만 남기고, 파라미터/필드/코드 목록은 전부 `API_README_v2.md`로 위임한다.

### 2.3 문서 우선순위 명시
- **목표**: 문서 간의 우선순위를 명확히 하고, 각 문서의 역할을 명시한다.
- **요구사항**:
    - CONTEXT.md > TECHNICAL_DESIGN.md > API_README_v2.md 순으로 우선순위를 선언한다.
    - 각 문서 상단에 "이 문서가 무엇을 책임지는지"를 3줄로 요약하는 인트로 섹션을 추가한다.
    - **Note**: 인트로 섹션 추가는 `implement` 단계에서 해당 파일을 직접 수정하여 반영된다.

## 3. 도메인 모델 개선 (Domain Model Requirements)

### 3.1 Race 도메인 타입 확장
- **목표**: Race 도메인 타입을 Next.js App Router 환경 및 안정적인 ID 전략에 맞춰 확장한다.
- **요구사항**:
    - 기존 필수 필드(`id`, `type`, `raceNo`, `track`, `startTime`, `distance`, `status`) 외에 다음 필드를 추가한다:
        - `date`: YYYY-MM-DD 문자열 (필수)
        - `meetCode`: 외부 API에서 내려오는 원시 회차/시행 코드 (필수)
    - **ID 전략**:
        - `id`는 "type-<meetCode>-<raceNo>-<date>" 형태처럼, 날짜와 회차가 포함된 안정적인 식별자로 규격화한다.
        - 동일한 외부 데이터에 대해 항상 같은 ID가 생성되도록 결정적(deterministic)이어야 한다.

### 3.2 하위 타입 (Entry/Runner 등) 정리
- **목표**: Entry/Runner 등 하위 타입을 도메인 기준으로 정리한다.
- **요구사항**:
    - **경마**: 말/기수/조교사/마방/부담중량/연령/최근 성적(최근 5~6회) 필드를 정리한다.
    - **경륜/경정**: 선수/기수/모터/보트/기록/점수/최근 성적 필드를 정리한다.

### 3.3 타입 변경 시 고려사항
- **목표**: 타입 정의 및 매핑 레이어를 명확히 하고, 견고성을 확보한다.
- **요구사항**:
    - 도메인 중심의 타입 정의 파일을 프로젝트 내 적절한 위치에 생성한다. (예: `src/types/race.ts`, `src/types/entry.ts` 등).
    - 외부 API 응답(raw) 타입과 내부 도메인 타입을 분리하고, 매핑 레이어를 명시적으로 구현한다.
    - `Race`/`Entry`/`Result`/`OddsSnapshot`에 대한 유닛 테스트를 추가하고, 스냅샷 테스트로 `ID`/`date`/`meetCode`가 항상 동일하게 생성되는지 보장한다.

## 4. API 레이어 정리 & 스펙 단일화 (API Layer & Spec Unification)

### 4.1 외부 API 호출 로직 분리
- **목표**: 외부 API 호출 로직을 통합 분리하여 관리한다.
- **요구사항**:
    - 외부 API 클라이언트 모듈들을 분리한다. (예: 한국마사회 클라이언트, 국민체육진흥공단 경륜 클라이언트, 국민체육진흥공단 경정 클라이언트)
    - 각 클라이언트 모듈에는 어떤 스펙 섹션(`API_README_v2.md` 내 섹션명)을 기준으로 했는지 주석으로 명시한다.

### 4.2 Next.js App Router (app/api) 역할 정의
- **목표**: Next.js `API 라우트 핸들러`의 역할을 명확히 제한한다.
- **요구사항**: `API 라우트 핸들러`는 다음 역할만 담당한다:
    - HTTP 요청 파라미터 검증
    - 서비스 호출 (예: `raceService.getDailyRaces`)
    - 에러를 HTTP 에러/JSON 에러로 변환하는 역할

### 4.3 RaceService 레이어 추가
- **목표**: 고수준 도메인 함수를 제공하고 외부 API 클라이언트와 Next.js Route 사이의 도메인 경계를 책임지는 RaceService 레이어를 추가한다.
- **요구사항**:
    - 서비스 레이어(예: `src/lib/services/raceService.ts` 혹은 디렉토리)를 만들어 "오늘의 경주 조회", "특정 날짜/종목별 경주 조회", "경주 상세 + 출전표 + 배당 + 결과 묶어서 조회"와 같은 고수준 도메인 함수를 제공한다.

### 4.4 API 에러 처리 정책 명시
- **목표**: 외부 API 오류 발생 시 일관된 에러 처리 정책을 정의한다.
- **요구사항**:
    - 공공데이터 API 오류, 타임아웃, null 응답 시 어떤 기본값/에러 메시지를 반환할지 규칙을 정리한다.
    - 최소한 "데이터 제공 기관(API) 지연으로 최신 정보가 표시되지 않을 수 있다"는 메시지를 프론트에 전달할 수 있게 한다.

## 5. 경주 상세 페이지 UX 리디자인 (Race Detail Page UX Redesign)

### 5.1 목표
"데이터가 있다"가 아니라, "이 정보를 보고 바로 판단이 된다" 수준으로 재구성한다.

### 5.2 상세 페이지 기본 레이아웃 구성
- **상단 요약 카드**:
    - 종목(type), 경주장(track), 회차(meetCode/raceNo), 등급, 거리, 출발 시간, 상태(출주/마감/결과 확정)를 한 번에 보여주는 카드 컴포넌트.
- **출전표 테이블**:
    - 번호, 마/선수 이름, 기수/조교사(또는 모터/보트), 부담중량/기록, 최근 성적, 단승/복승/쌍승 배당(가능한 범위까지)을 한 테이블에서 보여준다.
    - 현재처럼 테이블 + 아래 개별 섹션으로 중복되는 구조는 제거한다. 중복 정보는 축약형 카드나 hover 디테일로만 제공한다.
- **결과/배당 섹션**:
    - 착순 순서대로: 순위, 번호, 이름, 배당금(단승/복승/쌍승/삼쌍 등 가능한 조합)을 테이블로 정리한다.
    - 값이 없는 경우에는 왜 없는지(예: 아직 결과 미집계, 복승 미발매 등) 문구로 표시한다.
- **핵심 인사이트 블록**:
    - 인기 상위 3두(또는 선수)의 배당, 최근 성적, 실제 결과를 한눈에 비교하는 요약 카드.
    - **인기 상위 3두 선정 알고리즘**:
        1. **Primary**: 단승(win) 배당률 기준 낮은 순서 (낮을수록 인기 높음)
        2. **Fallback (배당 미제공 시)**: 최근 5회 성적 합계 기준 높은 순서
        3. **Tie-breaker**: 출전번호(entry no) 낮은 순서
        4. **예외 처리**: 배당 및 성적 데이터 모두 없는 경우 "인사이트 데이터 준비 중" 메시지 표시

### 5.3 로딩/에러/빈 상태 UX
- **목표**: 사용자에게 일관되고 유용한 로딩, 에러, 빈 상태 경험을 제공한다.
- **요구사항**:
    - 디자인 시스템에 정의한 Skeleton/시머/스낵바를 실제 상세 페이지에 전면 적용한다.
    - **로딩 시**: 요약 카드/출전표/결과 섹션마다 Skeleton을 사용해 구조를 유지한다.
    - **에러 시**: 단순 텍스트가 아니라, "공공데이터 API 오류/지연"을 명시하는 에러 컴포넌트로 처리하고, 재시도 버튼을 제공한다.

## 6. 관측(Observability) & SEO/측정 초기 세팅 (Observability & SEO/Measurement)

### 6.1 GA4 및 Search Console 연동
- **목표**: 사용자 행동 분석 및 검색 엔진 최적화를 위한 기본 연동을 설정한다.
- **요구사항**:
    - `NEXT_PUBLIC_GA_ID`, `Search Console` 설정을 `ENVIRONMENT.md`에 정리된 형식대로 실제 값 기준 예시와 함께 문서화한다(민감 값은 마스킹).
    - 최소 이벤트:
        - `tab_click`(type: horse/cycle/boat)
        - `race_detail_view`(type, track, raceNo, date)

### 6.2 에러/장애 모니터링
- **목표**: 서비스의 안정성 확보를 위해 에러 및 장애를 중앙에서 모니터링한다.
- **요구사항**:
    - 최소한 Sentry 또는 유사 서비스 하나를 붙여서 Next.js 서버 에러 및 외부 API 호출 에러를 중앙에서 볼 수 있게 한다.

### 6.3 SEO
- **목표**: 검색 엔진 최적화를 통해 서비스 노출도를 향상시킨다.
- **요구사항**:
    - 경주 상세 페이지 URL 패턴을 "type/date/track/raceNo" 위주로 읽기 좋게 정리한다.
    - head 메타에 `schema.org SportsEvent`(또는 하위 타입)를 적용하여 검색 엔진이 레이스 정보를 구조화된 데이터로 이해할 수 있게 한다.

## 7. 비범위 (Out of Scope for this Cycle)

- 회원 시스템/로그인/알림 기능 구현
- 구독/유료 결제 시스템 구축
- 별도의 백엔드 서버(Next.js 외) 도입 및 운영 자동화
- ML/AI 기반 추천/분석 기능
